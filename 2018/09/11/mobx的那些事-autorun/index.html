<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    <title>mobx的那些事-autorun | herec</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="react,mobx">
    <meta name="description" content="autoRun(view, opts) autorun接收两个参数,第一个参数是响应式函数,第二个参数是一个对象,可设置name,delay…等等.先看下autorun的入口函数,下面这段代码是入口函数的主要代码,可以看到它调用了Reaction1234reaction$$1 = new Reaction$$1(name, function () &amp;#123;     //this指向Reacti">
<meta name="keywords" content="react,mobx">
<meta property="og:type" content="article">
<meta property="og:title" content="mobx的那些事-autorun">
<meta property="og:url" content="http://yoursite.com/2018/09/11/mobx的那些事-autorun/index.html">
<meta property="og:site_name" content="herec">
<meta property="og:description" content="autoRun(view, opts) autorun接收两个参数,第一个参数是响应式函数,第二个参数是一个对象,可设置name,delay…等等.先看下autorun的入口函数,下面这段代码是入口函数的主要代码,可以看到它调用了Reaction1234reaction$$1 = new Reaction$$1(name, function () &amp;#123;     //this指向Reacti">
<meta property="og:image" content="http://yoursite.com/images/mobx-autorun.jpg">
<meta property="og:updated_time" content="2018-09-18T03:10:52.819Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="mobx的那些事-autorun">
<meta name="twitter:description" content="autoRun(view, opts) autorun接收两个参数,第一个参数是响应式函数,第二个参数是一个对象,可设置name,delay…等等.先看下autorun的入口函数,下面这段代码是入口函数的主要代码,可以看到它调用了Reaction1234reaction$$1 = new Reaction$$1(name, function () &amp;#123;     //this指向Reacti">
<meta name="twitter:image" content="http://yoursite.com/images/mobx-autorun.jpg">
    
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">herec</h5>
          <a href="mailto:453288875@qq.com" title="453288875@qq.com" class="mail">453288875@qq.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                Tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/herec" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="http://weibo.com/u/1955831145" target="_blank" >
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">mobx的那些事-autorun</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">mobx的那些事-autorun</h1>
        <h5 class="subtitle">
            
                <time datetime="2018-09-11T07:10:29.000Z" itemprop="datePublished" class="page-time">
  2018-09-11
</time>


            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#track"><span class="post-toc-number">1.</span> <span class="post-toc-text">track</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#bindDependencies"><span class="post-toc-number">2.</span> <span class="post-toc-text">bindDependencies</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#流程图"><span class="post-toc-number">3.</span> <span class="post-toc-text">流程图</span></a></li></ol>
        </nav>
    </aside>
    
<article id="post-mobx的那些事-autorun"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">mobx的那些事-autorun</h1>
        <div class="post-meta">
            <time class="post-time" title="2018-09-11 15:10:29" datetime="2018-09-11T07:10:29.000Z"  itemprop="datePublished">2018-09-11</time>

            


            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <p><em>autoRun(view, opts)</em></p>
<p>autorun接收两个参数,第一个参数是响应式函数,第二个参数是一个对象,可设置name,delay…等等.<br>先看下autorun的入口函数,下面这段代码是入口函数的主要代码,可以看到它调用了Reaction<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">reaction$$<span class="number">1</span> = <span class="keyword">new</span> Reaction$$<span class="number">1</span>(name, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">     <span class="comment">//this指向Reaction$$1</span></div><div class="line">     <span class="keyword">this</span>.track(reactionRunner);</div><div class="line"> &#125;, opts.onError);</div></pre></td></tr></table></figure></p>
<p>这段代码Reaction里面调用了Reaction的<em>track</em>方法,<em>reacitonRunner</em> 是我们刚传入的 <em>view</em>,</p>
<h2 id="track"><a href="#track" class="headerlink" title="track"></a>track</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">Reaction$$<span class="number">1.</span>prototype.track = <span class="function"><span class="keyword">function</span> (<span class="params">fn</span>) </span>&#123;</div><div class="line">    startBatch$$<span class="number">1</span>();</div><div class="line">    <span class="keyword">var</span> notify = isSpyEnabled$$<span class="number">1</span>();</div><div class="line">    <span class="keyword">var</span> startTime;</div><div class="line">    <span class="keyword">if</span> (notify &amp;&amp; process.env.NODE_ENV !== <span class="string">"production"</span>) &#123;</div><div class="line">        startTime = <span class="built_in">Date</span>.now();</div><div class="line">        spyReportStart$$<span class="number">1</span>(&#123;<span class="attr">name</span>: <span class="keyword">this</span>.name, <span class="attr">type</span>: <span class="string">"reaction"</span>&#125;);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">this</span>._isRunning = <span class="literal">true</span>;</div><div class="line">    <span class="keyword">var</span> result = trackDerivedFunction$$<span class="number">1</span>(<span class="keyword">this</span>, fn, <span class="literal">undefined</span>);</div><div class="line">    <span class="keyword">this</span>._isRunning = <span class="literal">false</span>;</div><div class="line">    <span class="keyword">this</span>._isTrackPending = <span class="literal">false</span>;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.isDisposed) &#123;</div><div class="line">        <span class="comment">// disposed during last run. Clean up everything that was bound after the</span></div><div class="line">        <span class="comment">// dispose call.</span></div><div class="line">        clearObserving$$<span class="number">1</span>(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (isCaughtException$$<span class="number">1</span>(result)) </div><div class="line">        <span class="keyword">this</span>.reportExceptionInDerivation(result.cause);</div><div class="line">    <span class="keyword">if</span> (notify &amp;&amp; process.env.NODE_ENV !== <span class="string">"production"</span>) &#123;</div><div class="line">        spyReportEnd$$<span class="number">1</span>(&#123;</div><div class="line">            time: <span class="built_in">Date</span>.now() - startTime</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">    endBatch$$<span class="number">1</span>();</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p> 在<em>track</em>里面我们看到 <em>trackDerivedFunction</em> ,<em>trackDerivedFunction</em> 的作用是把刚实例的 <em>Reaction</em> 保存到全局的 <em>globalState$$1.trackingDerivation</em> 里面, 当监听的对象或者属性调用get或者set的时候就会调用 <em>globalState$$1.trackingDerivation</em>.<br> 在 <em>trackDerivedFunction</em> 函数里面是用 <em>bindDependencies</em> 来更新新传入的 <em>Reaction</em>.</p>
<h2 id="bindDependencies"><a href="#bindDependencies" class="headerlink" title="bindDependencies"></a>bindDependencies</h2> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">bindDependencies</span>(<span class="params">derivation</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> prevObserving = derivation.observing;</div><div class="line">    <span class="keyword">var</span> observing = (derivation.observing = derivation.newObserving);</div><div class="line">    <span class="keyword">var</span> lowestNewObservingDerivationState = exports.IDerivationState.UP_TO_DATE;</div><div class="line">    <span class="keyword">var</span> i0 = <span class="number">0</span>,</div><div class="line">        l = derivation.unboundDepsCount; <span class="comment">//newObserving 的length</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; l; i++) &#123;</div><div class="line">        <span class="comment">//第一次遍历去除newObserving重复的,因为newObserving数组里面个对象是引用类型,</span></div><div class="line">        <span class="comment">//所以如果存在两个一样的对象的话,</span></div><div class="line">        <span class="comment">//第一个设diffValue为1,那么后面那个的diffValue也为1.</span></div><div class="line">        <span class="comment">//这是为什么要有if (i0 !== i)的判断,缺位补位</span></div><div class="line">        <span class="keyword">var</span> dep = observing[i];</div><div class="line">        <span class="keyword">if</span> (dep.diffValue === <span class="number">0</span>) &#123;</div><div class="line">            dep.diffValue = <span class="number">1</span>;</div><div class="line">            <span class="keyword">if</span> (i0 !== i) </div><div class="line">                observing[i0] = dep;</div><div class="line">            i0++;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// Upcast is 'safe' here, because if dep is IObservable, `dependenciesState`</span></div><div class="line">        <span class="comment">// will be undefined, not hitting the condition</span></div><div class="line">        <span class="keyword">if</span> (dep.dependenciesState &gt; lowestNewObservingDerivationState) &#123;</div><div class="line">            lowestNewObservingDerivationState = dep.dependenciesState;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    observing.length = i0;</div><div class="line">    derivation.newObserving = <span class="literal">null</span>; </div><div class="line"></div><div class="line">    l = prevObserving.length;</div><div class="line">    <span class="keyword">while</span> (l--) &#123;</div><div class="line">        <span class="comment">//第二次删除删除之前observing,同样是因为引用类型,所以在第一次遍历里面,</span></div><div class="line">        <span class="comment">//如果之前的observing里有跟newObserving一样的对象,</span></div><div class="line">        <span class="comment">//那么observing里面的那个对象的diffValue也会变为1,</span></div><div class="line">        <span class="comment">//所以可以删除旧的也没有在newObserving里的对象，所以剩下的设为0</span></div><div class="line">        <span class="keyword">var</span> dep = prevObserving[l];</div><div class="line">        <span class="keyword">if</span> (dep.diffValue === <span class="number">0</span>) &#123;</div><div class="line">            removeObserver$$<span class="number">1</span>(dep, derivation);</div><div class="line">        &#125;</div><div class="line">        dep.diffValue = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">while</span> (i0--) &#123;</div><div class="line">        <span class="comment">//第三次遍历把newObserving添加,</span></div><div class="line">        <span class="keyword">var</span> dep = observing[i0];</div><div class="line">        <span class="keyword">if</span> (dep.diffValue === <span class="number">1</span>) &#123;</div><div class="line">            dep.diffValue = <span class="number">0</span>;</div><div class="line">            addObserver$$<span class="number">1</span>(dep, derivation);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (lowestNewObservingDerivationState !== exports.IDerivationState.UP_TO_DATE) &#123;</div><div class="line">        derivation.dependenciesState = lowestNewObservingDerivationState;</div><div class="line">        derivation.onBecomeStale();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> <b>globalState$$1.trackingDerivation 是一个实例的Reaction,当执行对象或者属性的 <em>get</em> 或者 <em>set</em> 方法时候,会调用 <em>reportObserved</em> 或者 <em>propagateChanged</em>,<br> 然后会添加ovserving到 globalState$$1.trackingDerivation也就是Reaction里面,在trackDerivedFunction里面有句 <em>globalState$$1.trackingDerivation = derivation</em> (引用类型),所以改变globalState$$1.trackingDerivation 就是改变derivation ,如下代码:</b><br> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">reportObserved$$1</span>(<span class="params">observable$$<span class="number">1</span></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> derivation = globalState$$<span class="number">1.</span>trackingDerivation;</div><div class="line">    <span class="keyword">if</span> (derivation !== <span class="literal">null</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (derivation.runId !== observable$$<span class="number">1.</span>lastAccessedBy) &#123;</div><div class="line">            observable$$<span class="number">1.</span>lastAccessedBy = derivation.runId;</div><div class="line">            derivation.newObserving[derivation.unboundDepsCount++] = observable$$<span class="number">1</span>;</div><div class="line">            <span class="keyword">if</span> (!observable$$<span class="number">1.</span>isBeingObserved) &#123;</div><div class="line">                observable$$<span class="number">1.</span>isBeingObserved = <span class="literal">true</span>;</div><div class="line">                observable$$<span class="number">1.</span>onBecomeObserved();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (observable$$<span class="number">1.</span>observers.size === <span class="number">0</span> &amp;&amp; globalState$$<span class="number">1.</span>inBatch &gt; <span class="number">0</span>) &#123;</div><div class="line">        queueForUnobservation$$<span class="number">1</span>(observable$$<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">trackDerivedFunction$$1</span>(<span class="params">derivation, f, context</span>) </span>&#123;</div><div class="line">    changeDependenciesStateTo0$$<span class="number">1</span>(derivation);</div><div class="line">    derivation.newObserving = <span class="keyword">new</span> <span class="built_in">Array</span>(derivation.observing.length + <span class="number">100</span>); <span class="comment">//100+个空值的数组</span></div><div class="line">    </div><div class="line">    derivation.unboundDepsCount = <span class="number">0</span>;</div><div class="line">    derivation.runId = ++globalState$$<span class="number">1.</span>runId;</div><div class="line">    <span class="keyword">var</span> prevTracking = globalState$$<span class="number">1.</span>trackingDerivation; <span class="comment">//暂存先前的值</span></div><div class="line">    globalState$$<span class="number">1.</span>trackingDerivation = derivation;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> result;</div><div class="line">    <span class="keyword">if</span> (globalState$$<span class="number">1.</span>disableErrorBoundaries === <span class="literal">true</span>) &#123;</div><div class="line">        result = f.call(context);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            result = f.call(context);</div><div class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</div><div class="line">            result = <span class="keyword">new</span> CaughtException$$<span class="number">1</span>(e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    globalState$$<span class="number">1.</span>trackingDerivation = prevTracking; <span class="comment">//重赋先前的值</span></div><div class="line">    bindDependencies(derivation);</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p> <b>而为什么get的时候,只有view函数里面的属性有效果,如下</b><br> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> bankUser = mobx.observable(&#123;</div><div class="line">    name: <span class="string">'张三'</span>,</div><div class="line">    income: <span class="number">3</span>,</div><div class="line">    debit: <span class="number">2</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line">mobx.autorun(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'张三的账户存款:'</span>, bankUser.income);</div><div class="line">&#125;);</div><div class="line"><span class="comment">// _.times(8, function () &#123;</span></div><div class="line"><span class="comment">//     bankUser.income = _.random(40);</span></div><div class="line"><span class="comment">// &#125;);</span></div><div class="line"><span class="comment">// _.times(8, function () &#123;</span></div><div class="line"><span class="comment">//     bankUser.debit = _.random(40);</span></div><div class="line"><span class="comment">// &#125;);</span></div></pre></td></tr></table></figure></p>
<p> <strong>PS: observing保存的对象都是引用类型的, 所以可能添加两个一样的,修改一个就影响另外一个</strong><br> <b>Q1:为什么get或者set的时候,会打印view函数</b><br> 这是因为get或者set的时候会调用endBatch$$1函数里面的runReactions$$1()<br> <b>Q2:为什么只有调用bankUser.income时才能打印出来,debit没有打印</b><br> 这是因为 <em>runreaction</em> 函数里面 <em>shouldCompute$$1</em> 进行判断,类Reaction有一个 <em>dependenciesState</em> ,在 <em>shouldCompute$$1</em> 函数里面用 <em>switch (derivation.dependenciesState)</em> 做判断, 由于只有在值发生改变才会触发打印,所以每次执行完会调用 <em>changeDependenciesStateTo0$$1(derivation)</em></p>
<p>更新需要遍历两个数组,朴素算法的时间复杂度将是 O(n^2),bindDependencies用了3 次遍历 + diffValue 属性的辅助将复杂度降到了 O(n).</p>
<p><strong>第一次遍历:</strong> 先把新的observing的diffValue设为1,由于 <em>var observing = (derivation.observing = derivation.newObserving)</em> 所以derivation.observing的diffValue也为1<br><strong>第二次遍历：</strong>去掉先前的旧的数据<br><strong>第三次遍历：</strong>添加新的数据</p>
<h2 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h2><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/images/mobx-autorun.jpg" alt="流程" title="">
                </div>
                <div class="image-caption">流程</div>
            </figure>
        </div>

        <blockquote class="post-copyright">
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2018-09-18T03:10:52.819Z" itemprop="dateUpdated">2018-09-18 11:10:52</time>
</span><br>


        
        原始链接：<a href="/2018/09/11/mobx的那些事-autorun/" target="_blank" rel="external">http://yoursite.com/2018/09/11/mobx的那些事-autorun/</a>
        
    </div>
    <footer>
        <a href="http://yoursite.com">
            <img src="/img/avatar.jpg" alt="herec">
            herec
        </a>
    </footer>
</blockquote>

        
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>



        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mobx/">mobx</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/react/">react</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://yoursite.com/2018/09/11/mobx的那些事-autorun/&title=《mobx的那些事-autorun》 — herec&pic=http://yoursite.com/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://yoursite.com/2018/09/11/mobx的那些事-autorun/&title=《mobx的那些事-autorun》 — herec&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://yoursite.com/2018/09/11/mobx的那些事-autorun/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《mobx的那些事-autorun》 — herec&url=http://yoursite.com/2018/09/11/mobx的那些事-autorun/&via=http://yoursite.com" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://yoursite.com/2018/09/11/mobx的那些事-autorun/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2018/09/12/javascript笔记/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">javascript笔记</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2018/09/05/codeRoom/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">codeRoom</h4>
      </a>
    </div>
  
</nav>



    














</article>

<div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        谢谢客官~
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/img/wechat.jpg" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check"
                data-wechat="/img/wechat.jpg" data-alipay="/img/alipay.jpg">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-label"></span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
            <span>博客内容遵循 <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span>herec &copy; 2015 - 2018</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://yoursite.com/2018/09/11/mobx的那些事-autorun/&title=《mobx的那些事-autorun》 — herec&pic=http://yoursite.com/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://yoursite.com/2018/09/11/mobx的那些事-autorun/&title=《mobx的那些事-autorun》 — herec&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://yoursite.com/2018/09/11/mobx的那些事-autorun/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《mobx的那些事-autorun》 — herec&url=http://yoursite.com/2018/09/11/mobx的那些事-autorun/&via=http://yoursite.com" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://yoursite.com/2018/09/11/mobx的那些事-autorun/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="//api.qrserver.com/v1/create-qr-code/?data=http://yoursite.com/2018/09/11/mobx的那些事-autorun/" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: true };


</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>






<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<script>
(function() {
    var OriginTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            document.title = '死鬼去哪里了！';
            clearTimeout(titleTime);
        } else {
            document.title = '(つェ⊂)咦!又好了!';
            titleTime = setTimeout(function() {
                document.title = OriginTitile;
            },2000);
        }
    });
})();
</script>



</body>
</html>
